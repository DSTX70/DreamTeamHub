# DTH Hybrid Uploader Config Pack (DB + Env) — v1
Generated: 2025-11-12T04:23:46.051445 UTC

This pack upgrades your uploader config to a Hybrid model:
- Env (locked/sensitive): backend + provider secrets remain immutable at runtime.
- DB (runtime-editable): allowlist, maxMb, enabled, visibility with audit trail.
- RBAC: POST requires `ops_admin` (stub included).
- Design System UI: minimal, classless markup ready to skin with your DS tokens/components.

## Contents
- `migrations/001_ops_settings.sql` — tables + trigger for audit.
- `server/services/opsUploadsConfig.ts` — merge env→DB, validate & update.
- `server/routes/ops_uploader_config.ts` — GET/POST endpoints.
- `client/ops/UploaderSettings.tsx` — DS-friendly panel (no hardcoded colors).
- `.env.example` — reference env vars.

## Wire-up (Server)
1) Run SQL migration (PostgreSQL):
```
\\i migrations/001_ops_settings.sql
```
2) Install deps (if not present):
```
npm i express pg
npm i -D @types/express
```
3) Mount routes in your Express app:
```ts
import express from 'express';
import { opsUploaderConfigRouter } from './server/routes/ops_uploader_config';
const app = express();
app.use(express.json());
app.use('/api/ops/uploader', opsUploaderConfigRouter);
```

## Wire-up (Client)
Mount panel somewhere in your Ops menu route:
```tsx
import { UploaderSettings } from '@/client/ops/UploaderSettings';
export default function OpsUploaderSettingsPage() {
  return <UploaderSettings />;
}
```

## Env (locked/sensitive)
```
UPLOADS_BACKEND=local        # or drive|s3 (LOCKED)
GOOGLE_DRIVE_FOLDER_ID=
GOOGLE_APPLICATION_CREDENTIALS=./gcp-service.json
S3_BUCKET=
S3_REGION=
S3_ACCESS_KEY=
S3_SECRET_KEY=
# DB
DATABASE_URL=postgres://user:pass@host:5432/db
```

## Test
```
curl -s http://localhost:5000/api/ops/uploader/config | jq
curl -s -X POST http://localhost:5000/api/ops/uploader/config \
  -H "Content-Type: application/json" \
  -H "x-role: ops_admin" \
  -d '{"enabled":true,"allowlist":"json,csv,webp","maxMb":30,"visible_to":"pod"}' | jq
```