// web/components/CopilotPanel.tsx (React + fetch)
import React, { useState } from "react";

async function run(tool: string, params: any = {}) {
  const r = await fetch("/copilot/ask", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ tool, params }),
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

export default function CopilotPanel({ admin = false, gptUrl }: { admin?: boolean; gptUrl?: string }) {
  const [out, setOut] = useState<any>(null);
  const [err, setErr] = useState<string | null>(null);
  const onSmoke = async () => {
    setErr(null);
    try { setOut(await run("smokeTest")); } catch (e:any) { setErr(e.message); }
  };
  const onRoles = async () => {
    setErr(null);
    try { setOut(await run("listRoles", { limit: 5 })); } catch (e:any) { setErr(e.message); }
  };
  const onAgents = async () => {
    setErr(null);
    try { setOut(await run("getAgentSummaries", { limit: 5 })); } catch (e:any) { setErr(e.message); }
  };
  const onRouterSearch = async () => {
    setErr(null);
    try { setOut(await run("getAgentSummaries", { q: "router", limit: 5 })); } catch (e:any) { setErr(e.message); }
  };
  const onRoleByHandle = async () => {
    const handle = prompt("Role handle (e.g., product_owner)")?.trim();
    if (!handle) return;
    setErr(null);
    try { setOut(await run("getRoleByHandle", { handle })); } catch (e:any) { setErr(e.message); }
  };

  return (
    <div className="rounded-2xl border p-4 space-y-3">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">DTH Copilot</h3>
        {admin && gptUrl ? (
          <div className="flex items-center gap-2">
            <input readOnly className="border px-2 py-1 rounded w-72" value={gptUrl} />
            <button className="px-2 py-1 border rounded" onClick={() => navigator.clipboard.writeText(gptUrl)}>Copy GPT link</button>
          </div>
        ) : null}
      </div>

      <div className="flex flex-wrap gap-2">
        <button className="px-3 py-1 border rounded" onClick={onSmoke}>Smoke Test</button>
        <button className="px-3 py-1 border rounded" onClick={onRoles}>List L1 Support agents (table)</button>
        <button className="px-3 py-1 border rounded" onClick={onAgents}>Agents (limit 5)</button>
        <button className="px-3 py-1 border rounded" onClick={onRouterSearch}>Search “router”</button>
        <button className="px-3 py-1 border rounded" onClick={onRoleByHandle}>Role by handle…</button>
      </div>

      {err ? <div className="text-red-600 text-sm">{err}</div> : null}

      {out?.type === "table" && (
        <div className="overflow-auto">
          <table className="min-w-full text-sm">
            <thead>
              <tr>{out.columns.map((c: string) => <th key={c} className="text-left p-2 border-b">{c}</th>)}</tr>
            </thead>
            <tbody>
              {out.rows.map((r: any[], idx: number) => (
                <tr key={idx}>
                  {r.map((cell, j) => <td key={j} className="p-2 border-b">{String(cell)}</td>)}
                </tr>
              ))}
            </tbody>
          </table>
          {out.meta?.diagnostics?.length ? (
            <div className="text-xs text-amber-700 mt-2">
              Diagnostics: {out.meta.diagnostics.join("; ")}
            </div>
          ) : null}
        </div>
      )}

      {out?.result && (
        <div className="text-sm">
          <b>Smoke Test:</b> {out.result}
          <pre className="mt-1 bg-gray-50 p-2 rounded">{JSON.stringify(out.diagnostics, null, 2)}</pre>
        </div>
      )}

      {out?.type === "json" && (
        <pre className="text-xs bg-gray-50 p-2 rounded overflow-auto">{JSON.stringify(out.item, null, 2)}</pre>
      )}
    </div>
  );
}
