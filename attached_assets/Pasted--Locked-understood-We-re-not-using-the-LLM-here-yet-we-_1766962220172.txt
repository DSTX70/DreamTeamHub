✅ **Locked + understood.** We’re not using the LLM here (yet) — we’re upgrading the **static Recommendation** stage so it can **optionally embed read-only GigsterGarage file context** (Pilot C) using the connector helper you already created.

Below is a **paste-ready patch** (manual apply) for **DreamTeamHub** that:

* keeps your existing `buildRecommendation()` **unchanged** (backwards compatible)
* adds **`buildRecommendationWithRepoContext()` (async)** that:

  * detects Pilot C intent from `title + inputs`
  * fetches the 7 GG files via your helper
  * appends `FILE: … END_FILE` blocks + meta to the recommendation text
* updates the route to call the async builder

No DB changes. No schema changes. No auto-apply. No VSuiteHQ push.

---

# PATCH — DreamTeamHub

## 1) `server/lib/workItemStages.ts` (add async builder)

**Repo:** `DreamTeamHub`
**File:** `server/lib/workItemStages.ts`
**Apply:** Add the following code **below your existing `buildRecommendation()` export** (or near it).

```ts
// ADD near the top of the file (imports) if not already present:
import { fetchGigsterGarageFiles, formatGigsterFilesForPrompt } from "../services/connectors/gigsterGarageReadonly";

// ADD below buildRecommendation() (do not remove/rename existing buildRecommendation)

const PILOT_C_PATHS = [
  "client/src/hooks/useAuth.ts",
  "client/src/lib/queryClient.ts",
  "client/src/components/timer-widget.tsx",
  "client/src/pages/productivity.tsx",
  "client/src/pages/mobile-time-tracking.tsx",
  "client/src/components/app-header.tsx",
  "client/src/components/QuickActionButton.tsx",
];

function ggContextEnabled(): boolean {
  const v = (process.env.RECOMMENDATION_GG_CONTEXT_ENABLED ?? "true").toLowerCase().trim();
  return v !== "0" && v !== "false" && v !== "off";
}

function looksLikePilotC(text: string): boolean {
  const t = (text || "").toLowerCase();
  const keywords = [
    "pilot c",
    "401",
    "unauthorized",
    "auth",
    "authready",
    "isauthed",
    "useauth",
    "queryclient",
    "react-query",
    "tanstack",
    "retry",
    "refetch",
    "poll",
    "polling",
    "interval",
    "spam",
    "query noise",
    "refetchonwindowfocus",
    "refetchonmount",
    "refetchinterval",
    "staltime",
    "logout",
    "expired",
    "token",
  ];
  return keywords.some((k) => t.includes(k));
}

function repoIsGigsterGarage(repoHint?: string): boolean {
  return (repoHint || "").toLowerCase().includes("gigstergarage");
}

/**
 * New: async recommendation builder that can append read-only repo context (Pilot C).
 * No schema changes: uses only title/inputs/repoHint/strategySessionId.
 */
export async function buildRecommendationWithRepoContext(params: {
  title?: string;
  inputs?: string;
  repoHint?: string;
  strategySessionId?: string | null;
}): Promise<string> {
  // Start with your existing static recommendation template
  const base = buildRecommendation(params);

  // Hard gates: only for GigsterGarage + Pilot C-like work + env enabled + secrets present
  const hintText = `${params.title || ""}\n${params.inputs || ""}`;
  if (!ggContextEnabled()) return base;
  if (!repoIsGigsterGarage(params.repoHint)) return base;
  if (!looksLikePilotC(hintText)) return base;

  // Secrets must exist; if missing, just return base (no errors).
  if (!process.env.GIGSTER_GARAGE_BASE_URL || !process.env.GIGSTER_GARAGE_READONLY_TOKEN) return base;

  // Fetch + format context blocks
  const fetched = await fetchGigsterGarageFiles(PILOT_C_PATHS, {
    perFileMaxChars: 18_000,
    totalMaxChars: 75_000,
  });

  const metaLine =
    `requested=${fetched.meta.requestedCount} returned=${fetched.meta.returnedCount} ` +
    `nonEmpty=${fetched.meta.nonEmptyCount} errors=${fetched.meta.errorCount} ` +
    `truncatedChars=${fetched.meta.truncatedTotalChars}`;

  const ctx =
    `\n\n---\n` +
    `## Read-only repo context (GigsterGarage)\n` +
    `**Source:** DreamTeamHub → GigsterGarage read-only connector\n` +
    `**Meta:** ${metaLine}\n\n` +
    `Use the file blocks below to propose *specific diffs* that stop 401 spam + query noise.\n\n` +
    `${formatGigsterFilesForPrompt(fetched.files)}\n`;

  return base + ctx;
}
```

✅ Result: You now have a safe async builder that only attaches context when it’s clearly Pilot C.

---

## 2) `server/routes/workItemStages.ts` (use the async builder)

**Repo:** `DreamTeamHub`
**File:** `server/routes/workItemStages.ts`
**Apply:** Update your POST handler as follows.

### A) Import the new builder

Add/adjust your import from `workItemStages`:

```ts
import { buildRecommendation, buildRecommendationWithRepoContext } from "../lib/workItemStages";
```

### B) Change the route to call the async builder

Replace your current `const text = buildRecommendation(...)` line with:

```ts
const text = await buildRecommendationWithRepoContext({ title, inputs, repoHint, strategySessionId });
```

So the core becomes:

```ts
app.post("/api/work-items/:id/stage/recommendation", async (req, res) => {
  const workItemId = req.params.id;
  const rec = await getStage(workItemId);
  const { title, inputs, repoHint, strategySessionId } = req.body || {};

  const text = await buildRecommendationWithRepoContext({ title, inputs, repoHint, strategySessionId });

  // ... saves and returns
});
```

---

# Verification (fast)

1. **Set repo hint** to `GigsterGarage` and make inputs mention Pilot C:

   * include: “stop 401 spam”, “disable retry/refetch on 401”, “gate queries until authReady && isAuthed”
2. Generate recommendation.
3. Confirm the saved recommendation now includes:

* `## Read-only repo context (GigsterGarage)`
* `FILE: client/src/hooks/useAuth.ts … END_FILE`
* meta line with nonEmpty/errors

If you generate a recommendation for a different repo or a non-Pilot-C work item, it should **not** include any repo context.

---

# Next: Pilot C drop generation (real diffs, no placeholders)

Now that recommendations can carry real file context, the next step is:

* you trigger the recommendation for Pilot C
* copy/paste the generated recommendation text here (it will now include all 7 files)
* I generate the **GigsterGarage repo DROP** with exact, file-aware changes to:

  * gate protected queries until `authReady && isAuthed`
  * disable retry/refetch loops on 401
  * stop polling loops that spam 401 while logged out/expired

When you’re ready, paste the recommendation output (or just the 7 `FILE:` blocks) and I’ll ship the Pilot C patch drop for **GigsterGarage**.
