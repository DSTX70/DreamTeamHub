Locked ✅
Canonical slugs confirmed:

* **App Dev Guru** → `agent_app_development_guru` (alias: `agent_app_dev_guru`)
* **Izumi** → `agent_izumi_takahashi` (alias: `agent_izumi`)
* **Kaoru** → `agent_kaoru_arai` (alias: `agent_kaoru`)

Below is the **Option B patch** for **DreamTeamHub** that makes Curated-Cast deterministic by **normalizing aliases → canonical**, and ensuring the **Cast Receipt always writes canonical slugs** (even if the user selects/enters an alias).

---

```tsx
FILE: client/src/lib/canonSlugMap.ts
/**
 * Canonical slug map for known aliases.
 * Ensures deterministic routing + de-duped casting.
 */
export const CANON_SLUG_MAP: Record<string, string> = {
  // App Dev Guru
  agent_app_dev_guru: "agent_app_development_guru",

  // Izumi
  agent_izumi: "agent_izumi_takahashi",

  // Kaoru
  agent_kaoru: "agent_kaoru_arai",
};

export function toCanonSlug(slug: string): string {
  const s = (slug || "").trim();
  if (!s) return s;
  return CANON_SLUG_MAP[s] ?? s;
}

export function dedupeCanonSlugs(slugs: string[]): string[] {
  const canon = slugs
    .map(toCanonSlug)
    .map((x) => x.trim())
    .filter(Boolean);

  return Array.from(new Set(canon)).sort((a, b) => a.localeCompare(b));
}
END_FILE

FILE: client/src/pages/intent-console.tsx
import { useMemo, useState } from "react";
import { useMutation } from "@tanstack/react-query";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { useToast } from "@/hooks/use-toast";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { useLocation } from "wouter";
import { Target, Users, Wand2, X, Search } from "lucide-react";
import { useCastingPrefs } from "@/hooks/useCastingPrefs";
import { useCastOptions, CastOption } from "@/hooks/useCastOptions";
import { dedupeCanonSlugs, toCanonSlug } from "@/lib/canonSlugMap";

type Autonomy = "guided" | "standard" | "autonomous";

function buildTitle(intent: string): string {
  const clean = intent.trim().replace(/\s+/g, " ");
  if (!clean) return "New work item";
  return clean.length <= 80 ? clean : `${clean.slice(0, 77)}...`;
}

function normalizeManualSlugs(raw: string): string[] {
  return raw
    .split(",")
    .map((x) => x.trim())
    .filter(Boolean);
}

function optionLabelBySlug(options: CastOption[], slug: string): string {
  const canon = toCanonSlug(slug);
  const hit = options.find((o) => o.slug === canon) || options.find((o) => o.slug === slug);
  return hit?.label ?? canon ?? slug;
}

function formatCastReceipt(params: {
  mode: "auto" | "curated";
  podSlugs: string[];
  personaSlugs: string[];
  podOptions: CastOption[];
  personaOptions: CastOption[];
  autonomy: string;
}) {
  const { mode, podSlugs, personaSlugs, podOptions, personaOptions, autonomy } = params;

  const lines: string[] = [];
  lines.push("Cast Receipt");
  lines.push(`Mode: ${mode.toUpperCase()}`);
  lines.push(`Autonomy: ${autonomy.toUpperCase()}`);

  lines.push("Pods:");
  if (mode === "auto" || podSlugs.length === 0) {
    lines.push("  - AUTO");
  } else {
    for (const s of podSlugs) {
      const canon = toCanonSlug(s);
      lines.push(`  - name: ${optionLabelBySlug(podOptions, canon)} | slug: ${canon}`);
    }
  }

  lines.push("Personas:");
  if (mode === "auto" || personaSlugs.length === 0) {
    lines.push("  - AUTO");
  } else {
    for (const s of personaSlugs) {
      const canon = toCanonSlug(s);
      lines.push(`  - name: ${optionLabelBySlug(personaOptions, canon)} | slug: ${canon}`);
    }
  }

  return lines.join("\n");
}

function toggleInListCanon(list: string[], value: string): string[] {
  const canon = toCanonSlug(value.trim());
  if (!canon) return list;
  return list.includes(canon) ? list.filter((x) => x !== canon) : [...list, canon];
}

export default function IntentConsolePage() {
  const [intent, setIntent] = useState("");
  const [autonomy, setAutonomy] = useState<Autonomy>("standard");
  const { toast } = useToast();
  const [, setLocation] = useLocation();

  const { mode, setMode, pods, setPods, personas, setPersonas } = useCastingPrefs();
  const { pods: podOptions, podsOk, podsLoading, personas: personaOptions, personasOk, personasLoading } = useCastOptions();

  const [podFilter, setPodFilter] = useState("");
  const [personaFilter, setPersonaFilter] = useState("");
  const [manualPods, setManualPods] = useState("");
  const [manualPersonas, setManualPersonas] = useState("");

  const title = useMemo(() => buildTitle(intent), [intent]);

  // Always canonicalize + dedupe before using/storing
  const effectivePodSlugs = useMemo(() => {
    if (mode !== "curated") return [];
    const raw = podsOk ? pods : normalizeManualSlugs(manualPods);
    return dedupeCanonSlugs(raw);
  }, [mode, podsOk, pods, manualPods]);

  const effectivePersonaSlugs = useMemo(() => {
    if (mode !== "curated") return [];
    const raw = personasOk ? personas : normalizeManualSlugs(manualPersonas);
    return dedupeCanonSlugs(raw);
  }, [mode, personasOk, personas, manualPersonas]);

  const filteredPodOptions = useMemo(() => {
    const q = podFilter.trim().toLowerCase();
    if (!q) return podOptions;
    return podOptions.filter((p) => p.label.toLowerCase().includes(q) || p.slug.toLowerCase().includes(q));
  }, [podOptions, podFilter]);

  const filteredPersonaOptions = useMemo(() => {
    const q = personaFilter.trim().toLowerCase();
    if (!q) return personaOptions;
    return personaOptions.filter((p) => p.label.toLowerCase().includes(q) || p.slug.toLowerCase().includes(q));
  }, [personaOptions, personaFilter]);

  const createMutation = useMutation({
    mutationFn: async () => {
      const castReceipt = formatCastReceipt({
        mode,
        podSlugs: effectivePodSlugs,
        personaSlugs: effectivePersonaSlugs,
        podOptions,
        personaOptions,
        autonomy,
      });

      const payload = {
        title,
        description:
          (intent ? `Intent: ${intent.trim()}\n\n` : "") +
          `Autonomy: ${autonomy.toUpperCase()}\n\n---\n${castReceipt}\n---\n`,
        status: "todo",
        priority: "medium",
      };

      return apiRequest("POST", "/api/work-items", payload);
    },
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["/api/work-items"] });
      await queryClient.invalidateQueries({ queryKey: ["/api/control/dashboard"] });
      toast({
        title: "Queued",
        description:
          mode === "curated"
            ? "Your intent + curated cast (canonical slugs) were converted into a governed work item."
            : "Your intent was converted into a governed work item.",
      });
      setIntent("");
      setLocation("/work-orders");
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Could not create a work item from that intent.",
        variant: "destructive",
      });
    },
  });

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold mb-2" data-testid="page-title">
          Intent
        </h1>
        <p className="text-sm text-muted-foreground">
          Auto-Cast chooses the cast. Curated-Cast stores canonical slugs to keep routing deterministic (aliases auto-normalized).
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Target className="h-5 w-5" />
            What are you trying to accomplish?
          </CardTitle>
          <CardDescription>Outcome-first. Curate the cast when you want unique, non-generic results.</CardDescription>
        </CardHeader>

        <CardContent className="space-y-5">
          <div className="space-y-2">
            <label className="text-sm font-medium">Intent</label>
            <Textarea
              value={intent}
              onChange={(e) => setIntent(e.target.value)}
              placeholder="e.g., Run an IP + security + UX synthesis on this feature change."
              className="min-h-32"
              data-testid="intent-textarea"
            />
          </div>

          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <label className="text-sm font-medium">Autonomy</label>
              <Select value={autonomy} onValueChange={(v) => setAutonomy(v as Autonomy)}>
                <SelectTrigger data-testid="intent-autonomy">
                  <SelectValue placeholder="Select" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="guided">Guided</SelectItem>
                  <SelectItem value="standard">Standard</SelectItem>
                  <SelectItem value="autonomous">Autonomous</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Casting</label>
              <div className="flex gap-2">
                <Button
                  type="button"
                  variant={mode === "auto" ? "default" : "outline"}
                  size="sm"
                  className="gap-2"
                  onClick={() => setMode("auto")}
                  data-testid="cast-auto"
                >
                  <Wand2 className="h-4 w-4" />
                  Auto-Cast
                </Button>
                <Button
                  type="button"
                  variant={mode === "curated" ? "default" : "outline"}
                  size="sm"
                  className="gap-2"
                  onClick={() => setMode("curated")}
                  data-testid="cast-curated"
                >
                  <Users className="h-4 w-4" />
                  Curated-Cast
                </Button>
              </div>
              <p className="text-xs text-muted-foreground">
                Curated selections are canonicalized (aliases → canon) and written into the Cast Receipt.
              </p>
            </div>
          </div>

          {mode === "curated" && (
            <div className="rounded-lg border p-4 space-y-4" data-testid="curated-panel">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <div className="font-medium">Curated Cast (canonical slugs)</div>
                  <div className="text-xs text-muted-foreground">
                    Selecting an alias will automatically store the canonical slug.
                  </div>
                </div>
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    setPods([]);
                    setPersonas([]);
                    setManualPods("");
                    setManualPersonas("");
                  }}
                  className="gap-2"
                  data-testid="cast-clear"
                >
                  <X className="h-4 w-4" />
                  Clear
                </Button>
              </div>

              {/* Pods */}
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <label className="text-sm font-medium">Pods</label>
                  <span className="text-xs text-muted-foreground">Selected: {effectivePodSlugs.length}</span>
                </div>

                {podsOk ? (
                  <>
                    <div className="flex items-center gap-2">
                      <Search className="h-4 w-4 text-muted-foreground" />
                      <Input
                        value={podFilter}
                        onChange={(e) => setPodFilter(e.target.value)}
                        placeholder={podsLoading ? "Loading…" : "Filter by label or slug…"}
                        data-testid="pods-filter"
                      />
                    </div>

                    <div className="flex flex-wrap gap-2">
                      {filteredPodOptions.slice(0, 80).map((o) => {
                        const canon = toCanonSlug(o.slug);
                        const selected = effectivePodSlugs.includes(canon);
                        return (
                          <Badge
                            key={o.slug}
                            variant={selected ? "default" : "secondary"}
                            className="cursor-pointer select-none"
                            onClick={() => setPods(toggleInListCanon(pods, o.slug))}
                            title={`slug: ${o.slug}${canon !== o.slug ? ` → canon: ${canon}` : ""}`}
                            data-testid={`pod-${o.slug}`}
                          >
                            {o.label}
                          </Badge>
                        );
                      })}
                    </div>
                  </>
                ) : (
                  <>
                    <p className="text-xs text-muted-foreground">
                      Pod endpoint not detected. Enter pod slugs manually.
                    </p>
                    <Input
                      value={manualPods}
                      onChange={(e) => setManualPods(e.target.value)}
                      placeholder="e.g., pod_marketing, pod_ip, pod_security"
                      data-testid="pods-manual"
                    />
                  </>
                )}
              </div>

              {/* Personas */}
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <label className="text-sm font-medium">Personas</label>
                  <span className="text-xs text-muted-foreground">Selected: {effectivePersonaSlugs.length}</span>
                </div>

                {personasOk ? (
                  <>
                    <div className="flex items-center gap-2">
                      <Search className="h-4 w-4 text-muted-foreground" />
                      <Input
                        value={personaFilter}
                        onChange={(e) => setPersonaFilter(e.target.value)}
                        placeholder={personasLoading ? "Loading…" : "Filter by label or slug…"}
                        data-testid="personas-filter"
                      />
                    </div>

                    <div className="flex flex-wrap gap-2">
                      {filteredPersonaOptions.slice(0, 120).map((o) => {
                        const canon = toCanonSlug(o.slug);
                        const selected = effectivePersonaSlugs.includes(canon);
                        return (
                          <Badge
                            key={o.slug}
                            variant={selected ? "default" : "secondary"}
                            className="cursor-pointer select-none"
                            onClick={() => setPersonas(toggleInListCanon(personas, o.slug))}
                            title={`slug: ${o.slug}${canon !== o.slug ? ` → canon: ${canon}` : ""}`}
                            data-testid={`persona-${o.slug}`}
                          >
                            {o.label}
                          </Badge>
                        );
                      })}
                    </div>
                  </>
                ) : (
                  <>
                    <p className="text-xs text-muted-foreground">
                      Persona endpoint not detected. Enter persona slugs manually.
                    </p>
                    <Input
                      value={manualPersonas}
                      onChange={(e) => setManualPersonas(e.target.value)}
                      placeholder="e.g., agent_aegis, agent_sentinel, agent_prism"
                      data-testid="personas-manual"
                    />
                  </>
                )}
              </div>
            </div>
          )}

          <div className="flex items-center gap-3">
            <Button
              onClick={() => createMutation.mutate()}
              disabled={!intent.trim() || createMutation.isPending}
              data-testid="intent-submit"
            >
              Create Work Item
            </Button>
            <Button variant="outline" onClick={() => setLocation("/work-orders")} data-testid="intent-go-work">
              Go to Work
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
END_FILE
```

---

## Post-apply verification (fast)

1. `npm run check`
2. `npm run dev`
3. `/intent` → Curated-Cast
4. Select **App Dev Guru** (if alias appears) → verify selection stored as **`agent_app_development_guru`** in Cast Receipt
5. Create Work Item → confirm Cast Receipt lines use canonical slugs

---

## Next (optional, but recommended)

If you want **chip options even without `/api/roles`** working perfectly: I’ll add a `canonAgents.ts` fallback seeded with the exact slugs you pasted, so Curated-Cast always has selectable chips.
